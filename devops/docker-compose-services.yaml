services:
  external-data-consumer:
    image: external-data-consumer:latest
    restart: "no"
    ports:
      - "8081:8081"
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:8081/actuator/health || exit 1
      interval: 30s
      timeout: 5s
      start_period: 30s
      retries: 5
    environment:
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    labels:
      amplicode.image: springboot
    networks:
      - main-network

  itp-data-processing:
    image: itp-data-processing:latest
    restart: "no"
    ports:
      - "8082:8082"
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:8082/actuator/health || exit 1
      interval: 30s
      timeout: 5s
      start_period: 30s
      retries: 5
    environment:
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - NOMINATIM_URL=http://nominatim-moscow:8080
    labels:
      amplicode.image: springboot
    networks:
      - main-network

  vodokanal-data-service:
    image: vodokanal-data-service:latest
    restart: "no"
    ports:
      - "8083:8080"
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1
      interval: 30s
      timeout: 5s
      start_period: 30s
      retries: 5
    labels:
      amplicode.image: springboot
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/vodokanal_db
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - ITP_DATA_PROCESSING_URL=http://itp-data-processing:8082
    networks:
      - main-network

  itp-data-analyzing:
    image: analyzing-service:latest
    ports:
      - "8084:8084"
    environment:
      # Kafka настройки
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      KAFKA_GROUP_ID: itp-data-analyzing-group
      KAFKA_INPUT_TOPIC: external-itp-data
      KAFKA_OUTPUT_TOPIC: analyzing-itp-data
      # REST API настройки для главного сервиса
      VODOKANAL_BASE_URL: http://vodokanal-data-service:8081
      REST_TIMEOUT: 30
      REST_RETRIES: 3
      # Batch настройки
      BATCH_SIZE: 5
      BATCH_TIMEOUT: 30
      # ML Models настройки
      FORCE_DOWNLOAD_MODELS: "true"
      MODEL_MAX_AGE_HOURS: "24"
      # Python настройки
      PYTHONPATH: /app
      PYTHONUNBUFFERED: "1"
      PYTHONDONTWRITEBYTECODE: "1"
      # Logging
      LOG_LEVEL: INFO
      LOG_FILE_PATH: /app/logs/analyzing.log
      ASYNCIO_DEBUG: "0"
    networks:
      - app-network
    restart: "no"
    healthcheck:
      test: [ "CMD", "python", "-c", "import asyncio; print('Service is running'); exit(0)" ]
      interval: 30s
      timeout: 10s
      start_period: 120s  # Даем время на скачивание моделей
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

networks:
  main-network:
    external: true
